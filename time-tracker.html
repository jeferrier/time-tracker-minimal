<html>
	<head>
		<style>
			#summary-holder {
			}
			#input-holder {
			}
			#input-holder > tr {
				margin-bottom: 5px;
				font-family: monospace;
				box-sizing: content-box;
			}
			#input-holder td:nth-child(1) {
				width: 3%;
			}
			#input-holder td:nth-child(2) {
				width: 7%;
			}
			#input-holder td:nth-child(3) {
				width: 70%;
			}
			#input-holder td:nth-child(4) {
				width: 3%;
			}
			#input-holder .submit-button {
				height: 100%;
				background-color: grey;
				border: 1px solid green;
			}
		</style>
	</head>
	<body>
		<table id="summary-holder"></table>
		<table id="input-holder"></table>
	<body>
	<script type="text/javascript">
		// Generate a datestamp for today
		const today = new Date();
		const thisYear = String(today.getFullYear());
		const thisMonth = String(today.getMonth() + 1).padStart(2, '0');
		const thisDay = String(today.getDate()).padStart(2, '0');
		const thisDatestamp = thisYear + "-" + thisMonth + "-" + thisDay;

		const locallyStore = (thing) => {
			if (!thing && thing !== null){
				return;
			}
			if (thing === null){
				localStorage.removeItem('JEF-time-track.' + thisDatestamp);
			}
			localStorage.setItem('JEF-time-track.' + thisDatestamp, JSON.stringify(thing));
		};
		const locallyGet = () => {
			return JSON.parse(localStorage.getItem('JEF-time-track.' + thisDatestamp) || '{}');
		};

		const getCurrentTimeTodayRounded = () => {
			const currentTimeToday = new Date();
			currentTimeToday.setMinutes(Math.ceil(currentTimeToday.getMinutes() / 15) * 15, 0, 0);
			return currentTimeToday;
		};

		const getHTMLElementFromString = (string) => {
			var template = document.createElement('template');
			string = string.trim();
			template.innerHTML = string;
			return template.content.firstChild;
		};

		// Get the logs for today
		const todaysStats = locallyGet();
		console.log("Stats:", todaysStats);

		// Generate a summary of time spent today
		const summary = {};
		Object.keys(todaysStats).forEach((time) => {
			const details = todaysStats[time];
			const current = summary[details.type] || 0;
			summary[details.type] = current + 15;
		});
		let summaryString = '<pre>';
		Object.keys(summary).forEach((type) => {
			const details = summary[type];
			summaryString += (type + " " + String(details)).padStart(20, ' ');
		});
		summaryString += '</pre>';
		const summaryEl = document.querySelector('#summary-holder').appendChild(getHTMLElementFromString(summaryString));

		const types = [
			'not-working',
			'idle',
			'meeting',
			'unplanned-meeting',
			'task-management',
			'coding',
			'fire-fighting'
		];

		// Get the number of timeslots between now and the 'start' of today based on start time
		const startTimeToday = new Date(thisYear + "-" + thisMonth + "-" + thisDay + " 07:00");
		const currentTimeToday = getCurrentTimeTodayRounded();

		// For each time period not in the stats, add an html thing for it
		const inputHolderEl = document.querySelector('#input-holder');
		let lastType = '';
		while (startTimeToday <= currentTimeToday){
			const startTime = String(startTimeToday.getHours()).padStart(2, '0') + String(startTimeToday.getMinutes()).padStart(2, '0');
			// Check to see if the start time is in the stats already
			if (todaysStats[startTime]){
				lastType = todaysStats[startTime].type
				inputHolderEl.appendChild(getHTMLElementFromString(
					'<tr id="' + startTime + '">' +
						'<td>' + startTime + ':</td>' +
						'<td class="type">' + todaysStats[startTime].type + '</td>' +
						'<td class="explanation">&gt; ' + todaysStats[startTime].explanation + '</td>' +
						'<td></td>' +
					'</tr>'
				));
			} else {

				let selectOptions = "";
				types.forEach(type => {
					selectOptions += '<option value="' + type + '"';
					if (lastType == type){
						selectOptions += ' selected="true"';
					}
					selectOptions += '>' + type + '</option>';
				});
				// Create and insert the element
				inputHolderEl.appendChild(getHTMLElementFromString(
					'<tr id="' + startTime + '">' +
						'<td>' + startTime + ": </td>" +
						'<td>' +
							'<select>' + selectOptions + '</select>' +
						'</td>' +
						'<td>' +
							'<input type="text" style="width:97%;" placeholder="What did you do during this time"/>' +
						'</td>' +
						'<td>' +
							'<div class="submit-button"><center>save</center></div>' +
						'</td>' +
					'</tr>'
				));
				lastType = '';
			}

			startTimeToday.setMinutes(startTimeToday.getMinutes() + 15);
		}
		document.querySelectorAll('.submit-button').forEach((button) => {
			button.addEventListener('click', (evt) => {
				const timeEl = evt.target.parentElement.parentElement.parentElement;
				const startTime = timeEl.id;
				todaysStats[startTime] = {};
				todaysStats[startTime].type = timeEl.querySelector('select').selectedOptions[0].getAttribute('value');
				todaysStats[startTime].explanation = timeEl.querySelector('input').value;
				if (todaysStats[startTime].explanation == ''){
					todaysStats[startTime].explanation = 'N/A';
				}
				locallyStore(todaysStats);
				localStorage.setItem('JEF.scroll', window.pageYOffset);
				window.location = window.location;
			});
		});
		const lastScroll = localStorage.getItem('JEF.scroll');
		if (lastScroll){
			window.scroll(0, lastScroll);
			localStorage.removeItem('JEF.scroll');
		}
	</script>
</html>
